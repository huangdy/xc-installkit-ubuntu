@echo off

clear

set BRANDING=xChangeCore

echo.
echo -------------------------------------
echo  Beginning $BRANDING Installation
echo -------------------------------------

echo INFO: Setup OpenDJ
cd opendj && setup


echo INFO: Setup OpenFire
cd openfire && setup

:OPENFIRE
echo.
echo INSTALL:  Openfire
echo INFO: Extracting Openfire
cd %INSTALL_HOME%\Server
%JAREXE% -xf %CONFIG_HOME%\installFiles\%OPENFIREBASE%.zip
move %OPENFIREBASE% openfire

echo INFO:  Applying database configuration to Openfire
xcopy /I/R/Y %CONFIG_HOME%\configFiles\openfire %OPENFIRE_HOME%\conf

echo INFO:  Creating OpenFire database
%JAVAEXE% -cp %INSTALL_HOME%\setup\utility.jar com.saic.utility.FileRegex %INSTALL_HOME%\Server\openfire\conf\createOpenfire.sql "%%INSTALL_HOME%%" "%INSTALL_HOME%"
%JAVAEXE% -cp %INSTALL_HOME%\setup\utility.jar com.saic.utility.FileRegex %INSTALL_HOME%\Server\openfire\conf\createOpenfire.sql "%%FQDN%%" "%FQDN%"
%JAVAEXE% -cp %INSTALL_HOME%\setup\utility.jar com.saic.utility.FileRegex %INSTALL_HOME%\Server\openfire\conf\createOpenfire.sql "%%ADMINPASS%%" "%ADMINPASS%"
%JAVAEXE% -cp %INSTALL_HOME%\setup\utility.jar com.saic.utility.FileRegex %INSTALL_HOME%\Server\openfire\conf\createOpenfire.sql "%%SYSADMINPASS%%" "%SYSADMINPASS%"
%JAVAEXE% -cp %INSTALL_HOME%\setup\utility.jar com.saic.utility.FileRegex %INSTALL_HOME%\Server\openfire\conf\openfire.xml "%%SYSADMINPASS%%" "%SYSADMINPASS%"

echo INFO:  Applying database configuration
"C:\Program Files\Microsoft SQL Server\110\Tools\Binn"\sqlcmd.exe -U sa -P %SYSADMINPASS% -i %INSTALL_HOME%\Server\openfire\conf\createOpenfire.sql

echo INFO: Generating self-signed keys for Openfire
cd %OPENFIRE_HOME%\resources\security
set SERVER_DNAME="cn=%FQDN%,dc=uicds,dc=us"
set DAYS_VALID=365

%KEYTOOLEXE% -storepasswd -keystore keystore -new %SYSADMINPASS% -storepass changeit
%KEYTOOLEXE% -genkey -alias %FQDN% -keystore keystore -storepass %SYSADMINPASS% -validity %DAYS_VALID% -keypass %SYSADMINPASS% -dname %SERVER_DNAME%

cd %INSTALL_HOME%
echo INFO: Generating self-signed keys for Tomcat 
%KEYTOOLEXE% -genkey -keyalg RSA -keysize 2048 -alias tomcat -keystore keystore.jks -storepass %SYSADMINPASS% -keypass %SYSADMINPASS% -validity %DAYS_VALID% -dname "CN=%FQDN%,ou=uicds,o=uicds,l=uicds,st=uicds,c=US"

echo INFO: Fixing up server.xml with keystore filename and password
%JAVAEXE% -cp %INSTALL_HOME%\setup\utility.jar com.saic.utility.FileRegex %CONFIG_HOME%\configFiles\tomcat\conf\server.xml "keystoreFile=\"../../keystore\"" "keystoreFile=\"../../keystore.jks\"
%JAVAEXE% -cp %INSTALL_HOME%\setup\utility.jar com.saic.utility.FileRegex %CONFIG_HOME%\configFiles\tomcat\conf\server.xml "keystorePass=\"keystore\"" "keystorePass=\"%SYSADMINPASS%\"


echo INFO: Installing Openfire as a Windows Service
%OPENFIRE_HOME%\bin\openfire-service.exe /install
sc config "Openfire" depend= OpenDJ

sc start Openfire

if defined JUMPTO (
  GOTO SUCCESS
)

:TOMCAT
echo.
echo INSTALL:  Tomcat
echo INFO: Extracting Tomcat
cd %INSTALL_HOME%\Server
%JAREXE% -xf %CONFIG_HOME%\InstallFiles\%TOMCATBASE%-windows-x64.zip
move %TOMCATBASE% %CATALINA_HOME%

echo INFO: Applying %BRANDING% configuration to Tomcat
xcopy /I/R/Y %CONFIG_HOME%\configFiles\tomcat\bin %CATALINA_HOME%\bin
xcopy /I/R/Y %CONFIG_HOME%\configFiles\tomcat\lib %CATALINA_HOME%\lib
xcopy /I/R/Y %CONFIG_HOME%\configFiles\tomcat\conf %CATALINA_HOME%\conf

xcopy /I/R/Y %CONFIG_HOME%\configFiles\mssql\*.jar %INSTALL_HOME%\ServerApps\uicds\WEB-INF\lib

%JAVAEXE% -cp %INSTALL_HOME%\setup\utility.jar com.saic.utility.FileRegex %INSTALL_HOME%\ServerApps\uicds\core.properties "%%SYSADMINPASS%%" "%SYSADMINPASS%"
REM - %JAVAEXE% -cp %INSTALL_HOME%\setup\utility.jar com.saic.utility.FileRegex %INSTALL_HOME%\ServerApps\uicds\WEB-INF\applicationContext-infra.xml "%%SYSADMINPASS%%" "%SYSADMINPASS%"
%JAVAEXE% -cp %INSTALL_HOME%\setup\utility.jar com.saic.utility.FileRegex %INSTALL_HOME%\ServerApps\uicds\core.properties "%%FQDN%%" "%FQDN%"
REM - %JAVAEXE% -cp %INSTALL_HOME%\setup\utility.jar com.saic.utility.FileRegex %INSTALL_HOME%\ServerApps\uicds\WEB-INF\applicationContext-infra.xml "%%INSTALL_HOME%%" "%INSTALL_HOME%"

REM - %JAVAEXE% -cp %INSTALL_HOME%\setup\utility.jar com.saic.utility.FileRegex %INSTALL_HOME%\ServerApps\uicds\WEB-INF\xmppBeans.xml "%%INSTALL_HOME%%" "%INSTALL_HOME%"
%JAVAEXE% -cp %INSTALL_HOME%\setup\utility.jar com.saic.utility.FileRegex %INSTALL_HOME%\ServerApps\uicds\core.properties "%%COREUSER%%" "%COREUSER%"
%JAVAEXE% -cp %INSTALL_HOME%\setup\utility.jar com.saic.utility.FileRegex %INSTALL_HOME%\ServerApps\uicds\core.properties "%%COREPASS%%" "%COREPASS%"
%JAVAEXE% -cp %INSTALL_HOME%\setup\utility.jar com.saic.utility.FileRegex %INSTALL_HOME%\ServerApps\uicds\core.properties "%%FQDN%%" "%FQDN%"
%JAVAEXE% -cp %INSTALL_HOME%\setup\utility.jar com.saic.utility.FileRegex %INSTALL_HOME%\ServerApps\uicds\core.properties "%%SYSADMINPASS%%" "%SYSADMINPASS%"
%JAVAEXE% -cp %INSTALL_HOME%\setup\utility.jar com.saic.utility.FileRegex %INSTALL_HOME%\ServerApps\uicds\core.properties "%%LOCLAT%%" "%LOCLAT%"
%JAVAEXE% -cp %INSTALL_HOME%\setup\utility.jar com.saic.utility.FileRegex %INSTALL_HOME%\ServerApps\uicds\core.properties "%%LOCLON%%" "%LOCLON%"

%JAVAEXE% -cp %INSTALL_HOME%\setup\utility.jar com.saic.utility.FileRegex %INSTALL_HOME%\ServerApps\manage\opendj-rest2ldap-servlet.json "%%SYSADMINPASS%%" "%SYSADMINPASS%"

%JAVAEXE% -cp %INSTALL_HOME%\setup\utility.jar com.saic.utility.FileRegex %INSTALL_HOME%\ServerApps\uicds\WEB-INF\web.xml "%%COREPASS%%" "%COREPASS%"



echo INFO: Setting Feed Config
%JAVAEXE% -cp %INSTALL_HOME%\setup\utility.jar com.saic.utility.FileRegex %INSTALL_HOME%\ServerApps\uicds\config\resources\config.xml "%%AGENCY%%" "%AGENCY%"
%JAVAEXE% -cp %INSTALL_HOME%\setup\utility.jar com.saic.utility.FileRegex %INSTALL_HOME%\ServerApps\uicds\config\resources\config.xml "%%CONTACTEMAIL%%" "%CONTACTEMAIL%"
%JAVAEXE% -cp %INSTALL_HOME%\setup\utility.jar com.saic.utility.FileRegex %INSTALL_HOME%\ServerApps\uicds\config\resources\config.xml "%%CONTACTPOC%%" "%CONTACTPOC%"
%JAVAEXE% -cp %INSTALL_HOME%\setup\utility.jar com.saic.utility.FileRegex %INSTALL_HOME%\ServerApps\uicds\config\resources\config.xml "%%FQDN%%" "%FQDN%"

IF %Res%==true (
%JAVAEXE% -cp %INSTALL_HOME%\setup\utility.jar com.saic.utility.FileRegex %INSTALL_HOME%\ServerApps\uicds\config\resources\config.xml "%%OPEN%%" " "
%JAVAEXE% -cp %INSTALL_HOME%\setup\utility.jar com.saic.utility.FileRegex %INSTALL_HOME%\ServerApps\uicds\config\resources\config.xml "%%LOCLAT%%" "%LOCLAT%"
%JAVAEXE% -cp %INSTALL_HOME%\setup\utility.jar com.saic.utility.FileRegex %INSTALL_HOME%\ServerApps\uicds\config\resources\config.xml "%%LOCLON%%" "%LOCLON%"
%JAVAEXE% -cp %INSTALL_HOME%\setup\utility.jar com.saic.utility.FileRegex %INSTALL_HOME%\ServerApps\uicds\config\resources\config.xml "%%STREET%%" "%STREET%"
%JAVAEXE% -cp %INSTALL_HOME%\setup\utility.jar com.saic.utility.FileRegex %INSTALL_HOME%\ServerApps\uicds\config\resources\config.xml "%%CITY%%" "%CITY%"
%JAVAEXE% -cp %INSTALL_HOME%\setup\utility.jar com.saic.utility.FileRegex %INSTALL_HOME%\ServerApps\uicds\config\resources\config.xml "%%STATE%%" "%STATE%"
%JAVAEXE% -cp %INSTALL_HOME%\setup\utility.jar com.saic.utility.FileRegex %INSTALL_HOME%\ServerApps\uicds\config\resources\config.xml "%%ZIP%%" "%ZIP%"
%JAVAEXE% -cp %INSTALL_HOME%\setup\utility.jar com.saic.utility.FileRegex %INSTALL_HOME%\ServerApps\uicds\config\resources\config.xml "%%END%%" " "
) ELSE (
%JAVAEXE% -cp %INSTALL_HOME%\setup\utility.jar com.saic.utility.FileRegex %INSTALL_HOME%\ServerApps\uicds\config\resources\config.xml "%%OPEN%%" "<!--"
%JAVAEXE% -cp %INSTALL_HOME%\setup\utility.jar com.saic.utility.FileRegex %INSTALL_HOME%\ServerApps\uicds\config\resources\config.xml "%%END%%" "-->")


echo INFO: Setting Admin Console Config
%JAVAEXE% -cp %INSTALL_HOME%\setup\utility.jar com.saic.utility.FileRegex %INSTALL_HOME%\ServerApps\uicds\console\globals.js "%%FQDN%%" "%FQDN%"

%JAVAEXE% -cp %INSTALL_HOME%\setup\utility.jar com.saic.utility.FileRegex %INSTALL_HOME%\ServerApps\uicds\META-INF\context.xml "%%SYSADMINPASS%%" "%SYSADMINPASS%"

echo INFO: Installing Tomcat as a Windows Service
call %CATALINA_HOME%\bin\service.bat install Tomcat
call %CATALINA_HOME%\bin\tomcat7 //US//Tomcat --DisplayName="%BRANDING% Tomcat" --Environment=CATALINA_HOME="%CATALINA_HOME%" --Jvm=auto --StartMode=jvm --StopMode=jvm --StartClass=org.apache.catalina.startup.Bootstrap --StartParams=start --StopClass=org.apache.catalina.startup.Bootstrap --StopParams=stop --Startup=auto --StartPath="%INSTALL_HOME%"

sc start Tomcat

if defined JUMPTO (
  GOTO SUCCESS
)


:AUTOSERVICE
echo.
echo INFO: Setting %BRANDING% Service Startup to Auto
sc.exe config opendj start= delayed-auto
sc.exe config openfire start= delayed-auto
sc.exe config tomcat start= delayed-auto
if defined JUMPTO (
  GOTO SUCCESS
}

GOTO SUCCESS

:FAIL
echo.
echo %BRANDING% Setup did not complete
echo.
ENDLOCAL
exit /B -1

:SUCCESS
cd %INSTALL_HOME%
echo.
echo %BRANDING% Setup Complete
echo.
ENDLOCAL
exit /B 0
